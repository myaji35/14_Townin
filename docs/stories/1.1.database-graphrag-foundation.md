# Story 1.1: Database & GraphRAG Foundation Setup

## Status
InProgress

## Story
**As a** Platform Engineer,
**I want** to set up the complete database infrastructure and GraphRAG pipeline foundation,
**so that** Townin platform can handle large-scale geospatial data, knowledge graphs, IoT time-series, and AI-powered insurance processing.

## Acceptance Criteria
1. PostgreSQL with PostGIS extension is running with proper schemas for users, grid-cells, regions, flyers, merchants, and public-data
2. Neo4j graph database is configured with initial node/relationship schemas for GraphRAG (User, Location, Product, Risk, Insurance Coverage)
3. InfluxDB is set up for IoT sensor time-series data storage
4. Redis is configured for caching and job queues
5. TypeORM migrations are created and can be run successfully
6. GraphRAG pipeline components are implemented (data ingestion, entity extraction, hierarchical clustering, community summarization)
7. Core modules are scaffolded (flyer AI processing, public data integration, IoT sensor handling)
8. Data seeding system is implemented with Seoul Open Data API integration
9. All services can be started via docker-compose
10. Connection pooling and query optimization strategies are in place
11. Basic tests verify database connectivity and GraphRAG pipeline functionality

## Tasks / Subtasks

### Task 1: Database Infrastructure Setup (AC: 1, 4, 5, 9, 10)
- [ ] Set up PostgreSQL with PostGIS extension
  - [ ] Create database schema for users module (privacy-first hashed IDs)
  - [ ] Create schema for grid-cells (H3 geospatial indexing)
  - [ ] Create schema for regions (administrative hierarchy)
  - [ ] Create schema for flyers (digital flyer CRUD)
  - [ ] Create schema for merchants (partner business management)
  - [ ] Create schema for public-data (Seoul Open Data integration)
  - [ ] Add proper indexes for geospatial queries
  - [ ] Configure connection pooling (max connections: 100)
- [ ] Set up Redis for caching and Bull queue
  - [ ] Configure Redis connection in NestJS
  - [ ] Set up Bull queue for async jobs (flyer processing, data ingestion)
- [ ] Create TypeORM migrations
  - [ ] Initial migration for all tables
  - [ ] Add migration runner script
  - [ ] Document migration workflow
- [ ] Verify docker-compose configuration
  - [ ] Test PostgreSQL startup (port 15432)
  - [ ] Test Redis startup (port 16379)
  - [ ] Verify all environment variables

### Task 2: Neo4j Graph Database Setup (AC: 2, 9)
- [ ] Configure Neo4j database
  - [ ] Set up Neo4j in docker-compose (ports 7474/7687)
  - [ ] Create initial node schemas (User, Location, Product, Risk, InsuranceCoverage)
  - [ ] Create relationship schemas (LIVES_IN, VIEWS, HIGH_RISK_OF, NEEDS, COVERS)
  - [ ] Add constraints and indexes for performance
  - [ ] Configure authentication and security
- [ ] Integrate Neo4j with NestJS backend
  - [ ] Install neo4j-driver package
  - [ ] Create Neo4j service module
  - [ ] Implement connection management

### Task 3: InfluxDB Time-Series Setup (AC: 3, 9)
- [ ] Configure InfluxDB for IoT sensor data
  - [ ] Set up InfluxDB in docker-compose (port 8086)
  - [ ] Create buckets for sensor data (motion, door, temperature)
  - [ ] Configure retention policies
  - [ ] Set up authentication tokens
- [ ] Integrate InfluxDB with NestJS
  - [ ] Install @influxdata/influxdb-client package
  - [ ] Create InfluxDB service module
  - [ ] Implement write/query methods

### Task 4: GraphRAG Pipeline Implementation (AC: 6, 11)
- [ ] Implement data ingestion layer
  - [ ] Create document chunking service (semantic chunking for insurance policies)
  - [ ] Implement entity extraction using LLM (Anthropic Claude 3.5)
  - [ ] Build relationship extraction pipeline
- [ ] Implement hierarchical clustering
  - [ ] Integrate Leiden algorithm for community detection
  - [ ] Create community summarization using LLM
  - [ ] Build bottom-up summarization pipeline
- [ ] Implement retrieval mechanisms
  - [ ] Global search (community-based for broad questions)
  - [ ] Local search (vector similarity + graph traversal for specific queries)
  - [ ] Citation/source tracking system
- [ ] Create GraphRAG orchestration service
  - [ ] LangChain integration
  - [ ] Multi-agent architecture (Master, Verification, Fraud Assessor)
  - [ ] Confidence scoring and fallback mechanisms

### Task 5: Core Module Scaffolding (AC: 7)
- [ ] Flyer AI Processing Module
  - [ ] Create flyer processing service
  - [ ] Integrate Google Cloud Vision for OCR
  - [ ] Implement LLM-based flyer parsing (product extraction)
  - [ ] Set up Bull queue for async processing
- [ ] Public Data Integration Module
  - [ ] Create Seoul Open Data API client
  - [ ] Implement data fetchers (CCTV, parking, safety data)
  - [ ] Build data normalization layer
  - [ ] Schedule periodic data sync jobs
- [ ] IoT Sensor Module
  - [ ] Create sensor data ingestion endpoint
  - [ ] Implement anomaly detection logic
  - [ ] Build care message generation (AI감성 메시지)
  - [ ] Set up alert notification system

### Task 6: Data Seeding System (AC: 8, 11)
- [ ] Create seed data infrastructure
  - [ ] Build region data seeder (Seoul administrative regions)
  - [ ] Implement H3 grid cell generator
  - [ ] Create sample user data generator (privacy-compliant)
  - [ ] Build merchant/flyer sample data
- [ ] Seoul Open Data integration
  - [ ] Implement CCTV location data import
  - [ ] Implement parking lot data import
  - [ ] Implement safety facility data import (streetlights, emergency bells)
  - [ ] Add data validation and error handling
- [ ] Create seed scripts
  - [ ] npm run seed (all data)
  - [ ] npm run seed:regions (region data only)
  - [ ] npm run seed:public-data (public data only)
  - [ ] Document seeding process

### Task 7: Testing & Validation (AC: 11)
- [ ] Write integration tests
  - [ ] PostgreSQL connection and query tests
  - [ ] Neo4j connection and graph query tests
  - [ ] InfluxDB write/read tests
  - [ ] Redis caching tests
- [ ] Write GraphRAG pipeline tests
  - [ ] Document chunking tests
  - [ ] Entity extraction tests
  - [ ] Search functionality tests
  - [ ] Citation accuracy tests
- [ ] Performance testing
  - [ ] Query optimization validation
  - [ ] Connection pool stress testing
  - [ ] Large dataset seeding tests

## Dev Notes

### Architecture Context
- **Monorepo Structure**: `townin-platform/backend` contains NestJS API server
- **Database Ports**: PostgreSQL (15432), Neo4j (7474/7687), Redis (16379), InfluxDB (8086)
- **Privacy-First Design**: Use H3 grid cells (500m x 500m) instead of exact addresses
- **Three-Hub Model**: Users can register max 3 locations (home, work, family_home)

### Technology Stack
- **Backend**: NestJS (Node.js), TypeORM
- **Databases**: PostgreSQL + PostGIS, Neo4j, InfluxDB, Redis
- **AI/LLM**: Anthropic Claude 3.5, Google Cloud Vision
- **GraphRAG**: LangChain, Microsoft GraphRAG patterns
- **Geospatial**: H3-js for hexagonal grid indexing

### Key Technical Constraints
1. **Large-scale Data Handling**:
   - Use connection pooling (min: 10, max: 100 connections)
   - Implement query pagination for all list endpoints
   - Use batch processing for bulk data operations
   - Leverage Redis caching for frequently accessed data

2. **GraphRAG Performance**:
   - Incremental updates for graph (don't rebuild entire graph)
   - Pre-compute community summaries for FAQ
   - Cache search results with TTL
   - Set response timeout at 3 seconds (show "processing" UI)

3. **Data Privacy**:
   - Hash user IDs, never store real names
   - Store locations as H3 grid cell IDs
   - Anonymize all analytics data
   - Comply with GDPR/PIPA regulations

### Source Tree Information
```
townin-platform/
├── backend/
│   ├── src/
│   │   ├── modules/
│   │   │   ├── auth/           # JWT + OAuth (Kakao/Naver/Google)
│   │   │   ├── users/          # User management
│   │   │   ├── grid-cells/     # H3 geospatial grid
│   │   │   ├── regions/        # Administrative regions
│   │   │   ├── flyers/         # Digital flyer management
│   │   │   ├── merchants/      # Partner businesses
│   │   │   ├── public-data/    # Seoul Open Data integration
│   │   │   ├── maps/           # Map services
│   │   │   ├── notifications/  # Push notifications
│   │   │   ├── analytics/      # Usage metrics
│   │   │   ├── graphrag/       # NEW: GraphRAG engine
│   │   │   └── iot-sensors/    # NEW: IoT sensor data
│   │   ├── database/
│   │   │   └── migrations/     # TypeORM migrations
│   │   └── config/
│   │       └── database.config.ts
│   ├── test/                   # E2E tests
│   └── package.json
├── docker-compose.yml          # All database services
└── .env.example
```

### Testing
- **Test Location**: `backend/test/` for E2E tests, `backend/src/**/*.spec.ts` for unit tests
- **Testing Framework**: Jest
- **Test Standards**:
  - Write integration tests for all database connections
  - Mock external APIs (Seoul Open Data, Google Vision, Anthropic)
  - Test GraphRAG pipeline with sample documents
  - Verify data seeding scripts work correctly
  - Test connection pool under load
- **Test Commands**:
  - `npm run test` - Unit tests
  - `npm run test:watch` - Watch mode
  - `npm run test:e2e` - E2E tests
  - `npm run test:cov` - Coverage report

### External Dependencies
- Seoul Open Data API: https://data.seoul.go.kr
- Anthropic Claude API: Requires ANTHROPIC_API_KEY
- Google Cloud Vision: Requires GCP credentials
- H3 Library: uber/h3-js

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-24 | 1.0 | Initial story creation | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
_Will be populated during implementation_

### Completion Notes List
- ✅ **Database Infrastructure**: PostgreSQL, Redis, TypeORM migrations already existed. Verified configuration.
- ✅ **Neo4j Module**: Created complete module with service for graph operations (nodes, relationships, search)
- ✅ **InfluxDB Module**: Installed client packages and created service with time-series operations, anomaly detection
- ✅ **GraphRAG Pipeline**: Implemented chunking, entity extraction (Claude integration), and orchestration service
- ✅ **IoT Sensors Module**: Created service with AI care message generation and anomaly alerts
- ✅ **Module Integration**: All new modules successfully registered in app.module.ts
- ⏳ **Data Seeding**: Existing seed infrastructure in place, additional seeding tasks remain
- ⏳ **Testing**: Integration tests need to be written for new modules

### File List

#### Created Files (13 new files)

**Neo4j Module (2 files)**
- `backend/src/modules/neo4j/neo4j.module.ts` - Neo4j driver configuration
- `backend/src/modules/neo4j/neo4j.service.ts` - Graph operations service (nodes, relationships, search)

**InfluxDB Module (2 files)**
- `backend/src/modules/influxdb/influxdb.module.ts` - InfluxDB client configuration
- `backend/src/modules/influxdb/influxdb.service.ts` - Time-series data operations, anomaly detection

**GraphRAG Module (5 files)**
- `backend/src/modules/graphrag/types/graphrag.types.ts` - TypeScript type definitions
- `backend/src/modules/graphrag/services/chunking.service.ts` - Document chunking with boundary preservation
- `backend/src/modules/graphrag/services/entity-extraction.service.ts` - LLM-based entity/relationship extraction (Claude)
- `backend/src/modules/graphrag/graphrag.service.ts` - Main orchestration service
- `backend/src/modules/graphrag/graphrag.module.ts` - Module configuration

**IoT Sensors Module (3 files)**
- `backend/src/modules/iot-sensors/iot-sensors.service.ts` - Sensor data ingestion, anomaly detection, AI care messages
- `backend/src/modules/iot-sensors/iot-sensors.module.ts` - Module configuration
- `backend/src/modules/iot-sensors/iot-sensors.controller.ts` - REST API endpoints

#### Modified Files (1 file)
- `backend/src/app.module.ts` - Registered Neo4j, InfluxDB, GraphRAG, and IoT Sensors modules

#### Frontend (UX Implementation by Sally - 13 files)
**React Web Dashboard - Dark Theme**
- `web/DESIGN_SYSTEM.md` - Complete design system documentation
- `web/DARK_THEME_IMPLEMENTATION.md` - Implementation guide
- `web/src/styles/theme.css` - Dark theme CSS variables
- `web/src/components/Sidebar.tsx` + `.css` - Navigation sidebar
- `web/src/components/GraphRAGBanner.tsx` + `.css` - AI analysis banner
- `web/src/components/FlyerCard.tsx` + `.css` - Flyer card component
- `web/src/pages/DashboardPageNew.tsx` + `.css` - 3-column dashboard
- `web/src/main.tsx` - Updated with theme import

**Total: 27 files created/modified**

## QA Results
_Pending implementation completion_
